#cloud-config
users:
  - name: peter
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: dialout,plugdev
    shell: /bin/bash
    lock_passwd: true
    ssh_authorized_keys:
{% for key in ssh_authorized_keys %}
      - {{ key }}
{% endfor %}
{% for user in extra_users %}
  - name: {{ user.name }}
{% if user.sudo | default(false) %}
    sudo: ALL=(ALL) NOPASSWD:ALL
{% endif %}
    groups: dialout,plugdev
    shell: {{ user.shell | default('/bin/bash') }}
    lock_passwd: true
{% if user.ssh_keys | default(true) %}
    ssh_authorized_keys:
{% for key in ssh_authorized_keys %}
      - {{ key }}
{% endfor %}
{% endif %}
{% endfor %}

disable_root: true

ssh_pwauth: false
ssh_deletekeys: true

package_update: true
package_upgrade: true

packages:
  - linux-image-amd64
  - curl
  - git
  - build-essential
  - usbutils
  - ufw
  - fail2ban
  - unattended-upgrades
  - apt-listchanges
{% for pkg in extra_packages %}
  - {{ pkg }}
{% endfor %}

runcmd:
  # Harden SSH configuration
  - sed -i "s/^#*PermitRootLogin.*/PermitRootLogin no/" /etc/ssh/sshd_config
  - sed -i "s/^#*PasswordAuthentication.*/PasswordAuthentication no/" /etc/ssh/sshd_config
  - sed -i "s/^#*ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/" /etc/ssh/sshd_config
  - sed -i "s/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/" /etc/ssh/sshd_config
  - sed -i "s/^#*X11Forwarding.*/X11Forwarding no/" /etc/ssh/sshd_config
  - echo "MaxAuthTries 3" >> /etc/ssh/sshd_config
  - echo "MaxSessions 2" >> /etc/ssh/sshd_config
  - echo "ClientAliveInterval 300" >> /etc/ssh/sshd_config
  - echo "ClientAliveCountMax 2" >> /etc/ssh/sshd_config
  - systemctl restart sshd
  # Configure UFW firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw --force enable
  # Configure fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  # Enable automatic security updates
  - echo 'APT::Periodic::Update-Package-Lists "1";' > /etc/apt/apt.conf.d/20auto-upgrades
  - echo 'APT::Periodic::Unattended-Upgrade "1";' >> /etc/apt/apt.conf.d/20auto-upgrades
  - echo 'APT::Periodic::AutocleanInterval "7";' >> /etc/apt/apt.conf.d/20auto-upgrades
  # Set up secure shared memory
  - echo "tmpfs /run/shm tmpfs defaults,noexec,nodev,nosuid 0 0" >> /etc/fstab
  # Disable unnecessary services
  - systemctl disable --now avahi-daemon 2>/dev/null || true
  # Kernel hardening via sysctl
  - echo "net.ipv4.conf.all.send_redirects = 0" >> /etc/sysctl.d/99-hardening.conf
  - echo "net.ipv4.conf.default.send_redirects = 0" >> /etc/sysctl.d/99-hardening.conf
  - echo "net.ipv4.conf.all.accept_redirects = 0" >> /etc/sysctl.d/99-hardening.conf
  - echo "net.ipv4.conf.default.accept_redirects = 0" >> /etc/sysctl.d/99-hardening.conf
  - echo "net.ipv4.conf.all.accept_source_route = 0" >> /etc/sysctl.d/99-hardening.conf
  - echo "net.ipv4.conf.default.accept_source_route = 0" >> /etc/sysctl.d/99-hardening.conf
  - echo "net.ipv4.icmp_echo_ignore_broadcasts = 1" >> /etc/sysctl.d/99-hardening.conf
  - echo "net.ipv4.icmp_ignore_bogus_error_responses = 1" >> /etc/sysctl.d/99-hardening.conf
  - echo "net.ipv4.tcp_syncookies = 1" >> /etc/sysctl.d/99-hardening.conf
  - echo "net.ipv6.conf.all.accept_redirects = 0" >> /etc/sysctl.d/99-hardening.conf
  - echo "net.ipv6.conf.default.accept_redirects = 0" >> /etc/sysctl.d/99-hardening.conf
  - echo "kernel.dmesg_restrict = 1" >> /etc/sysctl.d/99-hardening.conf
  - sysctl -p /etc/sysctl.d/99-hardening.conf
{% for cmd in extra_runcmd %}
{% if '\n' in cmd %}
  - |
{{ cmd | indent(4, first=True) }}
{% else %}
  - {{ cmd }}
{% endif %}
{% endfor %}
  - echo "VM setup complete" >> /var/log/cloud-init-output.log

final_message: "VM {{ vm_name }} is ready!"
