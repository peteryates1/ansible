#!/bin/bash
# VM management wrapper script
# Usage:
#   ./vm create common01 common         # Create common base VM
#   ./vm create git01 git               # Create Git Server VM
#   ./vm create jop01 jop-dev           # Create JOP FPGA dev VM (auto-runs setup)
#   ./vm create jop02 jop-dev 16384 8   # Override: 16G RAM, 8 vCPUs
#   ./vm destroy claude01           # Destroy VM
#   ./vm start claude01             # Start VM
#   ./vm stop claude01              # Stop VM
#   ./vm status claude01            # Get VM status
#   ./vm ip claude01                # Get VM IP address
#   ./vm list                       # List all VMs
#   ./vm ssh claude01 [user]        # SSH to VM (default: peter)
#   ./vm ssh claude01 -- lsusb      # Run command as default user
#   ./vm ssh claude01 claude -- lsusb  # Run command as specific user
#   ./vm copy-key claude01 git01    # Copy claude's SSH key to git user on git01
#   ./vm usb-list                    # List host USB devices with IDs and names
#   ./vm usb-serials                 # List USB serial ports and mapped USB identity
#   ./vm usb-attach claude01 09fb:6001 "Altera Blaster"             # Attach unique USB device
#   ./vm usb-attach jop 0403:6010 "Arrow USB Blaster TEI0050"       # Attach duplicate ID by name
#   ./vm usb-attach fpga01 0403:6010 001:011 "Arrow Blaster"        # Attach specific duplicate USB ID
#   ./vm usb-detach 09fb:6001 "Altera Blaster"                      # Detach USB device from all VMs
#   ./vm usb-detach fpga01 0403:6010 001:011 "Arrow Blaster"        # Detach from specific VM
#   ./vm usb-detach-all pico                                        # Detach all USB devices from a VM
#   ./vm usb-detach-all                                              # Detach all USB devices from all VMs
#   ./vm usb-cleanup jop01              # Remove stale USB entries (unplugged devices)
#   ./vm usb-auto pico 2e8a:000a                                    # Auto-passthrough USB device to VM
#   ./vm usb-auto jop-claude 09fb:6001 "Altera Blaster"             # Auto-passthrough with name filter
#   ./vm usb-auto-remove pico 2e8a:000a                             # Remove auto-passthrough
#   ./vm usb-auto-list                                               # List active auto-passthrough rules
#   ./vm usb-watchers                                                # List active unplug watchers
#   ./vm usb-watchers clean                                          # Kill all stale watchers
#   ./vm install-blaster jop [user]     # Install Arrow USB Blaster support in VM
#   ./vm install-alchitry jop [user]   # Install Alchitry AU udev rules in VM
#   ./vm install-spinalhdl fpga01 [user]  # Install Java/Scala/sbt toolchain in VM
#   ./vm install-claude jop01             # Install Claude Code (creates claude user)
#   ./vm install-claude jop01 peter      # Install Claude Code for existing user
#   ./vm install-opencode jop01          # Install OpenCode (creates opencode user)
#   ./vm install-opencode jop01 peter    # Install OpenCode for existing user
#   ./vm install-vscode jop01            # Install Visual Studio Code
#   ./vm install-codium jop01            # Install VSCodium
#   ./vm resize-disk jop 64G              # Resize VM disk and grow guest filesystem
#   ./vm set-passwd jop peter              # Set login password for user (for xrdp)
#   ./vm share-dir jop /opt/xilinx/2025.2                     # Share host dir into VM (same mount point)
#   ./vm share-dir jop /opt/xilinx/2025.2 /opt/xilinx/2025.2  # Share host dir with explicit mount point
#   ./vm mount-shares jop01          # Restart VM and mount all attached shares
#   ./vm setup jop01 jop-dev         # Run post-creation setup (share dirs, install toolchains)
#   ./vm gui                         # Launch graphical VM manager
#   ./vm mirror add https://github.com/jop-devel/jop.git      # Clone a repo to /srv/git
#   ./vm mirror list                                           # List all repos
#   ./vm mirror sync [repo]                                    # Pull updates for all or one repo
#   ./vm mirror remove jop                                     # Remove a repo
#
# Template commands:
#   ./vm template create common     # Create hardened base template
#   ./vm template create git        # Create Git Server template
#   ./vm template create jop-dev    # Create JOP FPGA development template
#   ./vm template list              # List all templates
#   ./vm template destroy common    # Remove a template

set -e
cd "$(dirname "$0")"

ACTION="${1:-help}"
VM_NAME="${2:-}"
ARG3="${3:-}"
ARG4="${4:-}"

run_playbook() {
    local playbook="$1"
    shift
    sudo ansible-playbook "playbooks/${playbook}.yml" "$@"
}

list_host_usb() {
    sudo bash <<'SCRIPT'
set -euo pipefail

if ! command -v lsusb >/dev/null 2>&1; then
  echo "lsusb command not found. Install usbutils on host."
  exit 1
fi

printf "%-7s %-9s %-11s %-30s %s\n" "Bus" "Device" "ID" "Manufacturer" "Product"
printf "%-7s %-9s %-11s %-30s %s\n" "-----" "------" "----------" "------------------------------" "------------------------------"

pair_file="$(mktemp)"
cleanup() {
  rm -f "$pair_file"
}
trap cleanup EXIT

while IFS= read -r line; do
  [ -z "$line" ] && continue

  bus="$(echo "$line" | awk '{print $2}')"
  dev="$(echo "$line" | awk '{gsub(":", "", $4); print $4}')"
  id="$(echo "$line" | awk '{print $6}')"
  dev_path="/dev/bus/usb/${bus}/${dev}"

  manufacturer=""
  product=""
  if [ -e "$dev_path" ]; then
    desc="$(lsusb -D "$dev_path" -v 2>/dev/null || true)"
    manufacturer="$(printf '%s\n' "$desc" | awk '/^[[:space:]]*iManufacturer[[:space:]]+[0-9]+/ && !found { $1=""; $2=""; sub(/^[[:space:]]+/, ""); print; found=1 }')"
    product="$(printf '%s\n' "$desc" | awk '/^[[:space:]]*iProduct[[:space:]]+[0-9]+/ && !found { $1=""; $2=""; sub(/^[[:space:]]+/, ""); print; found=1 }')"
  fi

  [ -n "$manufacturer" ] || manufacturer="-"
  [ -n "$product" ] || product="-"
  printf "%-7s %-9s %-11s %-30s %s\n" "$bus" "$dev" "$id" "$manufacturer" "$product"

  usb_name="$product"
  if [ "$usb_name" = "-" ]; then
    usb_name="$manufacturer"
  fi
  if [ "$usb_name" = "-" ]; then
    usb_name="USB Device"
  fi
  usb_name_sanitized="$(printf '%s' "$usb_name" | tr '"' "'")"
  printf '%s "%s"\n' "$id" "$usb_name_sanitized" >> "$pair_file"
done < <(lsusb)

echo ""
echo "Copy/paste USB args for: ./vm usb-attach <vm_name> <usb_id> <usb_name>"
sort -u "$pair_file"
SCRIPT
}

list_host_usb_serials() {
    sudo bash <<'SCRIPT'
set -euo pipefail

shopt -s nullglob
ttys=(/dev/ttyUSB* /dev/ttyACM*)

if [ "${#ttys[@]}" -eq 0 ]; then
  echo "No /dev/ttyUSB* or /dev/ttyACM* devices found."
  exit 0
fi

printf "%-11s %-7s %-7s %-11s %-42s %s\n" "TTY" "Bus" "Device" "ID" "Name" "Serial"
printf "%-11s %-7s %-7s %-11s %-42s %s\n" "-----------" "-----" "------" "----------" "------------------------------------------" "------------------------------"

pair_file="$(mktemp)"
cleanup() {
  rm -f "$pair_file"
}
trap cleanup EXIT

for tty in "${ttys[@]}"; do
  props="$(udevadm info --query=property --name "$tty" 2>/dev/null || true)"

  vid="$(printf '%s\n' "$props" | awk -F= '/^ID_VENDOR_ID=/{print $2; exit}')"
  pid="$(printf '%s\n' "$props" | awk -F= '/^ID_MODEL_ID=/{print $2; exit}')"
  vendor_db="$(printf '%s\n' "$props" | awk -F= '/^ID_VENDOR_FROM_DATABASE=/{print $2; exit}')"
  model_db="$(printf '%s\n' "$props" | awk -F= '/^ID_MODEL_FROM_DATABASE=/{print $2; exit}')"
  vendor_raw="$(printf '%s\n' "$props" | awk -F= '/^ID_VENDOR=/{print $2; exit}')"
  model_raw="$(printf '%s\n' "$props" | awk -F= '/^ID_MODEL=/{print $2; exit}')"
  serial_short="$(printf '%s\n' "$props" | awk -F= '/^ID_SERIAL_SHORT=/{print $2; exit}')"

  [ -n "$vendor_db" ] || vendor_db="$(printf '%s' "${vendor_raw:-}" | tr '_' ' ')"
  [ -n "$model_db" ] || model_db="$(printf '%s' "${model_raw:-}" | tr '_' ' ')"
  [ -n "$serial_short" ] || serial_short="-"
  [ -n "$vendor_db" ] || vendor_db="-"
  [ -n "$model_db" ] || model_db="-"

  usb_name="$model_db"
  if [ "$usb_name" = "-" ]; then
    usb_name="$vendor_db"
  fi
  if [ "$usb_name" = "-" ]; then
    usb_name="USB Serial Device"
  fi

  id="${vid:-????}:${pid:-????}"

  sys_path="$(readlink -f "/sys/class/tty/$(basename "$tty")/device" 2>/dev/null || true)"
  usb_dev_path="$sys_path"
  while [ -n "$usb_dev_path" ] && [ "$usb_dev_path" != "/" ]; do
    if [ -f "$usb_dev_path/idVendor" ] && [ -f "$usb_dev_path/idProduct" ]; then
      break
    fi
    usb_dev_path="$(dirname "$usb_dev_path")"
  done

  bus="---"
  devnum="---"
  if [ -n "$usb_dev_path" ] && [ -f "$usb_dev_path/busnum" ] && [ -f "$usb_dev_path/devnum" ]; then
    bus="$(printf '%03d' "$(cat "$usb_dev_path/busnum")")"
    devnum="$(printf '%03d' "$(cat "$usb_dev_path/devnum")")"
  fi

  printf "%-11s %-7s %-7s %-11s %-42s %s\n" "$tty" "$bus" "$devnum" "$id" "$vendor_db $model_db" "$serial_short"

  usb_name_sanitized="$(printf '%s' "$usb_name" | tr '"' "'")"
  printf '%s "%s"\n' "$id" "$usb_name_sanitized" >> "$pair_file"
done

echo ""
echo "Copy/paste USB args from serial devices:"
sort -u "$pair_file"
SCRIPT
}

get_vm_ip() {
    local vm_name="$1"
    local mac ip

    mac=$(virsh -c qemu:///system domiflist "$vm_name" 2>/dev/null | awk 'NR > 2 && $5 ~ /^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$/ { print $5; exit }')
    if [ -n "$mac" ]; then
        # Try DHCP leases first
        ip=$(virsh -c qemu:///system net-dhcp-leases default 2>/dev/null | awk -v mac="$mac" '
            BEGIN { IGNORECASE = 1 }
            $0 ~ mac {
                split($5, parts, "/")
                print parts[1]
                exit
            }
        ')
        # Try static DHCP reservations in network XML
        if [ -z "$ip" ]; then
            ip=$(virsh -c qemu:///system net-dumpxml default 2>/dev/null | awk -v mac="$mac" '
                BEGIN { IGNORECASE = 1 }
                $0 ~ mac && /ip=/ {
                    gsub(/.*ip=["\047]/, "")
                    gsub(/["\047].*/, "")
                    print
                    exit
                }
            ')
        fi
    fi

    if [ -z "$ip" ]; then
        ip=$(virsh -c qemu:///system domifaddr "$vm_name" 2>/dev/null | awk '
            /ipv4/ {
                split($4, parts, "/")
                print parts[1]
                exit
            }
        ')
    fi

    echo "$ip"
}

vm_role_types() {
    find roles -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | sort | awk '
        BEGIN { first = 1 }
        {
            if (!first) {
                printf ", "
            }
            printf "%s", $0
            first = 0
        }
        END {
            if (first) {
                printf "(none found)"
            }
            printf "\n"
        }
    '
}

case "$ACTION" in
    template)
        TEMPLATE_ACTION="${VM_NAME:-help}"
        TEMPLATE_TYPE="${ARG3:-}"
        case "$TEMPLATE_ACTION" in
            create)
                if [ -z "$TEMPLATE_TYPE" ]; then
                    echo "Usage: $0 template create <type>"
                    echo "Types: common, git, mate, jop-dev"
                    echo ""
                    echo "Template hierarchy:"
                    echo "  1. ./vm template create common    # Base hardened template"
                    echo "  2. ./vm template create git       # Requires common"
                    echo "  2. ./vm template create mate      # Requires common (MATE desktop + xrdp)"
                    echo "  2. ./vm template create jop-dev   # Requires common (MATE + FPGA dev tools)"
                    exit 1
                fi
                run_playbook template-create -e "template_type=$TEMPLATE_TYPE"
                ;;
            list)
                run_playbook template-list
                ;;
            destroy)
                if [ -z "$TEMPLATE_TYPE" ]; then
                    echo "Usage: $0 template destroy <type>"
                    echo "Types: common, git, mate, jop-dev"
                    exit 1
                fi
                run_playbook template-destroy -e "template_type=$TEMPLATE_TYPE"
                ;;
            *)
                echo "Template subcommands:"
                echo "  $0 template create <type>   Create a template (common, git, mate, jop-dev)"
                echo "  $0 template list            List all templates"
                echo "  $0 template destroy <type>  Remove a template"
                echo ""
                echo "Create templates in order: common -> git/mate/jop-dev"
                exit 1
                ;;
        esac
        ;;
    create)
        if [ -z "$VM_NAME" ] || [ -z "$ARG3" ]; then
            echo "Usage: $0 create <vm_name> <type> [memory_mb] [vcpus]"
            echo "Types: $(vm_role_types)"
            echo "Memory/vCPUs override role defaults (e.g. 8192 4, 16384 8)"
            echo ""
            echo "Examples:"
            echo "  $0 create jop01 jop-dev            # Role defaults"
            echo "  $0 create jop02 jop-dev 16384 8    # 16G RAM, 8 vCPUs"
            exit 1
        fi
        CREATE_EXTRA_ARGS=""
        if [ -n "$ARG4" ]; then
            CREATE_EXTRA_ARGS="$CREATE_EXTRA_ARGS -e vm_memory=$ARG4"
        fi
        if [ -n "${5:-}" ]; then
            CREATE_EXTRA_ARGS="$CREATE_EXTRA_ARGS -e vm_vcpus=${5}"
        fi
        run_playbook create -e "vm_name=$VM_NAME" -e "vm_role=$ARG3" $CREATE_EXTRA_ARGS
        # Run post-creation setup for types that need it
        case "$ARG3" in
            jop-dev)
                "$0" setup "$VM_NAME" "$ARG3"
                ;;
        esac
        ;;
    destroy)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 destroy <vm_name>"
            exit 1
        fi
        run_playbook destroy -e "vm_name=$VM_NAME"
        ;;
    start)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 start <vm_name>"
            exit 1
        fi
        run_playbook start -e "vm_name=$VM_NAME"
        ;;
    stop)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 stop <vm_name>"
            exit 1
        fi
        run_playbook stop -e "vm_name=$VM_NAME"
        ;;
    status)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 status <vm_name>"
            exit 1
        fi
        run_playbook status -e "vm_name=$VM_NAME"
        ;;
    ip)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 ip <vm_name>"
            exit 1
        fi
        IP=$(get_vm_ip "$VM_NAME")
        if [ -z "$IP" ]; then
            echo "Cannot determine IP for $VM_NAME. Is it running?"
            exit 1
        fi
        echo "$IP"
        ;;
    list)
        run_playbook list
        ;;
    ssh)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 ssh <vm_name> [user]"
            echo "   or: $0 ssh <vm_name> -- <command...>"
            echo "   or: $0 ssh <vm_name> <user> -- <command...>"
            echo "Default user: peter"
            exit 1
        fi
        # Disambiguate user vs command with "--":
        #   ./vm ssh <vm> -- <cmd...>
        #   ./vm ssh <vm> <user> -- <cmd...>
        # Legacy login-only:
        #   ./vm ssh <vm> <user>
        if [ "$ARG3" = "--" ]; then
            USER="peter"
            shift 3
        elif [[ "$ARG3" =~ ^[a-z_][a-z0-9_-]*$ ]] && [ "$ARG4" = "--" ]; then
            USER="$ARG3"
            shift 4
        elif [[ "$ARG3" =~ ^[a-z_][a-z0-9_-]*$ ]] && [ "$#" -eq 3 ]; then
            USER="$ARG3"
            shift 3
        else
            USER="peter"
            shift 2
        fi
        IP=$(get_vm_ip "$VM_NAME")
        if [ -z "$IP" ]; then
            echo "Cannot determine IP for $VM_NAME. Is it running?"
            exit 1
        fi
        echo "Connecting to $USER@$IP ($VM_NAME)..."
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$USER@$IP" "$@"
        ;;
    copy-key)
        if [ -z "$VM_NAME" ] || [ -z "$ARG3" ]; then
            echo "Usage: $0 copy-key <src_vm> <dest_vm> [src_user] [dest_user]"
            echo "Copies SSH public key from src_user on src_vm to dest_user on dest_vm"
            echo "Defaults: src_user=claude, dest_user=git"
            echo ""
            echo "Example: $0 copy-key claude01 git01"
            echo "         $0 copy-key claude01 git01 claude git"
            exit 1
        fi
        SRC_USER="${4:-claude}"
        DEST_USER="${5:-git}"
        run_playbook copy-key -e "src_vm=$VM_NAME" -e "dest_vm=$ARG3" -e "src_user=$SRC_USER" -e "dest_user=$DEST_USER"
        ;;
    usb-list)
        list_host_usb
        ;;
    usb-serials)
        list_host_usb_serials
        ;;
    usb-attach)
        if [ -z "$VM_NAME" ] || [ -z "$ARG3" ]; then
            echo "Usage: $0 usb-attach <vm_name> <usb_id> [usb_addr] [usb_name]"
            echo "usb_id format: vvvv:pppp (copy from lsusb)"
            echo "For duplicate IDs, prefer usb_name; use usb_addr (BBB:DDD) when needed."
            echo "Examples:"
            echo "  $0 usb-attach claude01 09fb:6001 \"Altera Blaster\""
            echo "  $0 usb-attach jop 0403:6010 \"Arrow USB Blaster TEI0050\""
            echo "  $0 usb-attach fpga01 0403:6010 001:011 \"Arrow Blaster\""
            exit 1
        fi
        USB_ADDR=""
        if [[ "$ARG4" =~ ^[0-9]{1,3}:[0-9]{1,3}$ ]]; then
            USB_ADDR="$ARG4"
            USB_NAME="${*:5}"
        else
            USB_NAME="${*:4}"
        fi
        if [ -n "$USB_NAME" ]; then
            if [ -n "$USB_ADDR" ]; then
                run_playbook usb-attach -e "vm_name=$VM_NAME" -e "usb_id=$ARG3" -e "usb_addr=$USB_ADDR" -e "usb_name='$USB_NAME'"
            else
                run_playbook usb-attach -e "vm_name=$VM_NAME" -e "usb_id=$ARG3" -e "usb_name='$USB_NAME'"
            fi
        else
            if [ -n "$USB_ADDR" ]; then
                run_playbook usb-attach -e "vm_name=$VM_NAME" -e "usb_id=$ARG3" -e "usb_addr=$USB_ADDR"
            else
                run_playbook usb-attach -e "vm_name=$VM_NAME" -e "usb_id=$ARG3"
            fi
        fi
        ;;
    usb-detach)
        # If first arg looks like a USB ID (vvvv:pppp), treat as: usb-detach <usb_id> [usb_name]
        # defaulting to detach from all VMs
        if [[ "$VM_NAME" =~ ^[0-9a-fA-F]{4}:[0-9a-fA-F]{4}$ ]]; then
            USB_ADDR=""
            if [[ "$ARG3" =~ ^[0-9]{1,3}:[0-9]{1,3}$ ]]; then
                USB_ADDR="$ARG3"
                USB_NAME="${*:4}"
            else
                USB_NAME="${*:3}"
            fi
            ARG3="$VM_NAME"
            VM_NAME="all"
        elif [ -z "$VM_NAME" ] || [ -z "$ARG3" ]; then
            echo "Usage: $0 usb-detach [vm_name] <usb_id> [usb_addr] [usb_name]"
            echo "usb_id format: vvvv:pppp (copy from lsusb)"
            echo "Omit vm_name to detach from all VMs."
            echo "Examples:"
            echo "  $0 usb-detach 09fb:6001 \"Altera Blaster\""
            echo "  $0 usb-detach claude01 09fb:6001"
            echo "  $0 usb-detach fpga01 0403:6010 001:011 \"Arrow Blaster\""
            exit 1
        else
            USB_ADDR=""
            if [[ "$ARG4" =~ ^[0-9]{1,3}:[0-9]{1,3}$ ]]; then
                USB_ADDR="$ARG4"
                USB_NAME="${*:5}"
            else
                USB_NAME="${*:4}"
            fi
        fi
        if [ "$VM_NAME" = "all" ]; then
            if [ -n "$USB_NAME" ]; then
                if [ -n "$USB_ADDR" ]; then
                    run_playbook usb-detach -e "usb_id=$ARG3" -e "usb_addr=$USB_ADDR" -e "usb_name='$USB_NAME'"
                else
                    run_playbook usb-detach -e "usb_id=$ARG3" -e "usb_name='$USB_NAME'"
                fi
            else
                if [ -n "$USB_ADDR" ]; then
                    run_playbook usb-detach -e "usb_id=$ARG3" -e "usb_addr=$USB_ADDR"
                else
                    run_playbook usb-detach -e "usb_id=$ARG3"
                fi
            fi
        else
            if [ -n "$USB_NAME" ]; then
                if [ -n "$USB_ADDR" ]; then
                    run_playbook usb-detach -e "vm_name=$VM_NAME" -e "usb_id=$ARG3" -e "usb_addr=$USB_ADDR" -e "usb_name='$USB_NAME'"
                else
                    run_playbook usb-detach -e "vm_name=$VM_NAME" -e "usb_id=$ARG3" -e "usb_name='$USB_NAME'"
                fi
            else
                if [ -n "$USB_ADDR" ]; then
                    run_playbook usb-detach -e "vm_name=$VM_NAME" -e "usb_id=$ARG3" -e "usb_addr=$USB_ADDR"
                else
                    run_playbook usb-detach -e "vm_name=$VM_NAME" -e "usb_id=$ARG3"
                fi
            fi
        fi
        ;;
    usb-detach-all)
        if [ -z "$VM_NAME" ]; then
            echo "Detaching all USB devices from all VMs..."
            run_playbook usb-detach-all
        else
            run_playbook usb-detach-all -e "vm_name=$VM_NAME"
        fi
        ;;
    usb-cleanup)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 usb-cleanup <vm_name>"
            echo "Removes stale USB device entries from VM config."
            echo "Use after physically unplugging USB devices."
            exit 1
        fi
        run_playbook usb-cleanup -e "vm_name=$VM_NAME"
        ;;
    usb-auto)
        if [ -z "$VM_NAME" ] || [ -z "$ARG3" ]; then
            echo "Usage: $0 usb-auto <vm_name> <usb_id> [usb_name]"
            echo "Sets up automatic USB passthrough (udev rule) so the device"
            echo "auto-attaches to the VM when plugged in."
            echo ""
            echo "Examples:"
            echo "  $0 usb-auto pico 2e8a:000a"
            echo "  $0 usb-auto pico 2e8a:0003              # RP2 Boot mode"
            echo "  $0 usb-auto jop-claude 09fb:6001 \"Altera Blaster\""
            echo "  $0 usb-auto jop-claude 0403:6010 \"Arrow USB Blaster\""
            exit 1
        fi
        USB_NAME="${*:4}"
        if [ -n "$USB_NAME" ]; then
            run_playbook usb-auto -e "vm_name=$VM_NAME" -e "usb_id=$ARG3" -e "usb_name='$USB_NAME'"
        else
            run_playbook usb-auto -e "vm_name=$VM_NAME" -e "usb_id=$ARG3"
        fi
        ;;
    usb-auto-remove)
        if [ -z "$VM_NAME" ] || [ -z "$ARG3" ]; then
            echo "Usage: $0 usb-auto-remove <vm_name> <usb_id>"
            echo "Removes automatic USB passthrough for a device."
            echo ""
            echo "Examples:"
            echo "  $0 usb-auto-remove pico 2e8a:000a"
            echo "  $0 usb-auto-remove jop-claude 09fb:6001"
            exit 1
        fi
        run_playbook usb-auto-remove -e "vm_name=$VM_NAME" -e "usb_id=$ARG3"
        ;;
    usb-auto-list)
        echo "Active USB auto-passthrough rules:"
        echo ""
        found=0
        for rule in /etc/udev/rules.d/90-vm-usb-*.rules; do
            [ -f "$rule" ] || continue
            found=1
            # Parse filename: 90-vm-usb-<vm>-<vendor><product>[-<serial>].rules
            base="$(basename "$rule" .rules)"
            suffix="${base#90-vm-usb-}"
            serial=""
            if [[ "$suffix" =~ ^(.*)-([0-9a-f]{8})-(.+)$ ]]; then
                vm_part="${BASH_REMATCH[1]}"
                devid="${BASH_REMATCH[2]}"
                serial="${BASH_REMATCH[3]}"
            elif [[ "$suffix" =~ ^(.*)-([0-9a-f]{8})$ ]]; then
                vm_part="${BASH_REMATCH[1]}"
                devid="${BASH_REMATCH[2]}"
            else
                continue
            fi
            vendor="${devid:0:4}"
            product="${devid:4:4}"
            if [ -n "$serial" ]; then
                printf "  %-20s %s:%s  serial=%-12s (%s)\n" "$vm_part" "$vendor" "$product" "$serial" "$(basename "$rule")"
            else
                printf "  %-20s %s:%s  (%s)\n" "$vm_part" "$vendor" "$product" "$(basename "$rule")"
            fi
        done
        if [ "$found" -eq 0 ]; then
            echo "  (none)"
        fi
        ;;
    usb-watchers)
        echo "Active USB passthrough watchers:"
        echo ""
        watchers=$(pgrep -af "vm-usb-passthrough watch" 2>/dev/null || true)
        if [ -z "$watchers" ]; then
            echo "  (none)"
        else
            echo "$watchers" | while IFS= read -r line; do
                pid=$(echo "$line" | awk '{print $1}')
                vm=$(echo "$line" | awk '{print $5}')
                vendor=$(echo "$line" | awk '{print $6}')
                product=$(echo "$line" | awk '{print $7}')
                printf "  pid %-8s %-20s %s:%s\n" "$pid" "$vm" "$vendor" "$product"
            done
        fi
        if [ "${2:-}" = "clean" ]; then
            if [ -n "$watchers" ]; then
                pkill -f "vm-usb-passthrough watch" 2>/dev/null || true
                echo ""
                echo "All watchers killed."
            fi
        fi
        ;;
    install-blaster)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 install-blaster <vm_name> [vm_user]"
            echo "Installs Arrow USB Blaster support (udev rules, config, .so)."
            echo "Copies Arrow .so into host Quartus linux64 dir (shared read-only into VM)."
            echo "Defaults: vm_user=peter"
            exit 1
        fi
        INSTALL_USER="${ARG3:-peter}"
        run_playbook install-blaster -e "vm_name=$VM_NAME" -e "vm_user=$INSTALL_USER"
        ;;
    install-alchitry)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 install-alchitry <vm_name> [vm_user]"
            echo "Installs Alchitry AU udev rules (FTDI FT2232H)."
            echo "Defaults: vm_user=peter"
            exit 1
        fi
        INSTALL_USER="${ARG3:-peter}"
        run_playbook install-alchitry -e "vm_name=$VM_NAME" -e "vm_user=$INSTALL_USER"
        ;;
    install-spinalhdl)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 install-spinalhdl <vm_name> [vm_user]"
            echo "Defaults: vm_user=peter"
            exit 1
        fi
        INSTALL_USER="${ARG3:-peter}"
        run_playbook install-spinalhdl -e "vm_name=$VM_NAME" -e "vm_user=$INSTALL_USER"
        ;;
    install-claude)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 install-claude <vm_name> [user]"
            echo "Installs Claude Code. Default: creates dedicated claude user."
            echo "Specify user to install for an existing user instead."
            exit 1
        fi
        if [ -n "$ARG3" ]; then
            run_playbook install-claude -e "vm_name=$VM_NAME" -e "claude_user=$ARG3" -e "create_user=false"
        else
            run_playbook install-claude -e "vm_name=$VM_NAME"
        fi
        ;;
    install-opencode)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 install-opencode <vm_name> [user]"
            echo "Installs OpenCode. Default: creates dedicated opencode user."
            echo "Specify user to install for an existing user instead."
            exit 1
        fi
        if [ -n "$ARG3" ]; then
            run_playbook install-opencode -e "vm_name=$VM_NAME" -e "opencode_user=$ARG3" -e "create_user=false"
        else
            run_playbook install-opencode -e "vm_name=$VM_NAME"
        fi
        ;;
    install-vscode)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 install-vscode <vm_name>"
            echo "Installs Visual Studio Code via Microsoft apt repo."
            exit 1
        fi
        run_playbook install-vscode -e "vm_name=$VM_NAME"
        ;;
    install-codium)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 install-codium <vm_name>"
            echo "Installs VSCodium via apt repo."
            exit 1
        fi
        run_playbook install-codium -e "vm_name=$VM_NAME"
        ;;
    resize-disk)
        if [ -z "$VM_NAME" ] || [ -z "$ARG3" ]; then
            echo "Usage: $0 resize-disk <vm_name> <size>"
            echo "Resizes VM disk and grows guest partition/filesystem."
            echo "Size format: e.g. 64G, 128G"
            echo ""
            echo "Example: $0 resize-disk jop 64G"
            exit 1
        fi
        run_playbook resize-disk -e "vm_name=$VM_NAME" -e "disk_size=$ARG3"
        ;;
    set-passwd)
        if [ -z "$VM_NAME" ] || [ -z "$ARG3" ]; then
            echo "Usage: $0 set-passwd <vm_name> <user>"
            echo "Sets a login password for a user in the VM (for xrdp, etc)."
            echo ""
            echo "Examples:"
            echo "  $0 set-passwd jop peter"
            echo "  $0 set-passwd jop claude"
            exit 1
        fi
        if ! [[ "$ARG3" =~ ^[a-z_][a-z0-9_-]*$ ]]; then
            echo "Invalid username: $ARG3"
            exit 1
        fi
        IP=$(get_vm_ip "$VM_NAME")
        if [ -z "$IP" ]; then
            echo "Cannot determine IP for $VM_NAME. Is it running?"
            exit 1
        fi
        echo "Setting password for $ARG3 on $VM_NAME ($IP)..."
        ssh -t -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$IP" "sudo passwd $ARG3"
        ;;
    share-dir)
        if [ -z "$VM_NAME" ] || [ -z "$ARG3" ]; then
            echo "Usage: $0 share-dir <vm_name> <host_dir> [mount_point]"
            echo "Shares a host directory into a VM via virtiofs (read-only)."
            echo "Default mount_point = host_dir (same path inside VM)."
            echo ""
            echo "Examples:"
            echo "  $0 share-dir jop /opt/xilinx/2025.2"
            echo "  $0 share-dir jop /opt/altera/25.1"
            echo "  $0 share-dir jop /opt/jdk1.8.0_202"
            exit 1
        fi
        MOUNT_POINT="${ARG4:-$ARG3}"
        run_playbook share-dir -e "vm_name=$VM_NAME" -e "host_dir=$ARG3" -e "mount_point=$MOUNT_POINT"
        ;;
    mount-shares)
        if [ -z "$VM_NAME" ]; then
            echo "Usage: $0 mount-shares <vm_name>"
            echo "Restarts VM and mounts all attached filesystem shares."
            echo "Use after attaching shares with share-dir in batch mode."
            exit 1
        fi
        run_playbook mount-shares -e "vm_name=$VM_NAME"
        ;;
    mirror)
        MIRROR_DIR="/srv/git"
        MIRROR_ACTION="${VM_NAME:-help}"
        case "$MIRROR_ACTION" in
            add)
                if [ -z "$ARG3" ]; then
                    echo "Usage: $0 mirror add <git-url>"
                    echo "Clones a repo into $MIRROR_DIR with full working tree."
                    echo "Share into VMs with: $0 share-dir <vm> $MIRROR_DIR"
                    echo "In VM: browse /srv/git/<repo> or clone locally to modify."
                    echo ""
                    echo "Example: $0 mirror add https://github.com/jop-devel/jop.git"
                    exit 1
                fi
                REPO_URL="$ARG3"
                REPO_NAME="$(basename "$REPO_URL" .git)"
                if [ -d "$MIRROR_DIR/$REPO_NAME" ]; then
                    echo "Repo already exists: $MIRROR_DIR/$REPO_NAME"
                    echo "Run '$0 mirror sync $REPO_NAME' to update it."
                    exit 0
                fi
                if [ ! -d "$MIRROR_DIR" ]; then
                    sudo mkdir -p "$MIRROR_DIR"
                    sudo chown "$(id -un):$(id -gn)" "$MIRROR_DIR"
                fi
                echo "Cloning $REPO_URL -> $MIRROR_DIR/$REPO_NAME ..."
                git clone "$REPO_URL" "$MIRROR_DIR/$REPO_NAME"
                echo "Done. Share into VMs with: $0 share-dir <vm> $MIRROR_DIR"
                ;;
            list)
                if [ ! -d "$MIRROR_DIR" ]; then
                    echo "No repos found. Repo dir: $MIRROR_DIR"
                    exit 0
                fi
                echo "Git repos in $MIRROR_DIR:"
                echo ""
                found=0
                for repo in "$MIRROR_DIR"/*/; do
                    [ -d "$repo/.git" ] || continue
                    found=1
                    name="$(basename "$repo")"
                    url="$(git -C "$repo" remote get-url origin 2>/dev/null || echo "(no remote)")"
                    branch="$(git -C "$repo" branch --show-current 2>/dev/null || echo "?")"
                    size="$(du -sh "$repo" 2>/dev/null | cut -f1)"
                    printf "  %-30s %-8s %8s  %s\n" "$name" "($branch)" "$size" "$url"
                done
                if [ "$found" -eq 0 ]; then
                    echo "  (none)"
                fi
                echo ""
                echo "Share into VMs with: $0 share-dir <vm> $MIRROR_DIR"
                echo "In VM: browse /srv/git/<repo> or git clone /srv/git/<repo> ~/<repo>"
                ;;
            sync)
                if [ ! -d "$MIRROR_DIR" ]; then
                    echo "No repos found."
                    exit 1
                fi
                if [ -n "$ARG3" ]; then
                    REPO_NAME="$(basename "$ARG3" .git)"
                    if [ ! -d "$MIRROR_DIR/$REPO_NAME" ]; then
                        echo "Repo not found: $MIRROR_DIR/$REPO_NAME"
                        exit 1
                    fi
                    echo "Syncing $REPO_NAME ..."
                    git -C "$MIRROR_DIR/$REPO_NAME" pull --ff-only
                else
                    for repo in "$MIRROR_DIR"/*/; do
                        [ -d "$repo/.git" ] || continue
                        name="$(basename "$repo")"
                        echo "Syncing $name ..."
                        git -C "$repo" pull --ff-only || echo "  (pull failed, try manual merge)"
                    done
                fi
                echo "Done."
                ;;
            remove)
                if [ -z "$ARG3" ]; then
                    echo "Usage: $0 mirror remove <repo-name>"
                    echo "Example: $0 mirror remove jop"
                    exit 1
                fi
                REPO_NAME="$(basename "$ARG3" .git)"
                if [ ! -d "$MIRROR_DIR/$REPO_NAME" ]; then
                    echo "Repo not found: $MIRROR_DIR/$REPO_NAME"
                    exit 1
                fi
                echo "Removing repo: $MIRROR_DIR/$REPO_NAME"
                rm -rf "$MIRROR_DIR/$REPO_NAME"
                echo "Done."
                ;;
            *)
                echo "Mirror subcommands:"
                echo "  $0 mirror add <git-url>      Clone a repo to $MIRROR_DIR"
                echo "  $0 mirror list               List all repos"
                echo "  $0 mirror sync [repo]        Pull updates for all or one repo"
                echo "  $0 mirror remove <repo>      Remove a repo"
                echo ""
                echo "Workflow:"
                echo "  $0 mirror add https://github.com/jop-devel/jop.git"
                echo "  $0 share-dir jop01 $MIRROR_DIR"
                echo "  # In VM: browse /srv/git/jop or git clone /srv/git/jop ~/jop"
                exit 1
                ;;
        esac
        ;;
    gui)
        exec python3 "$(dirname "$0")/gui/main.py"
        ;;
    setup)
        if [ -z "$VM_NAME" ] || [ -z "$ARG3" ]; then
            echo "Usage: $0 setup <vm_name> <type>"
            echo "Types: jop-dev"
            echo ""
            echo "Runs post-creation setup: shares host directories and installs host-side tools."
            echo ""
            echo "For jop-dev, shares /opt/altera, /opt/eclipse, /opt/.p2, /opt/jdk1.6*,"
            echo "/opt/jdk1.8*, /opt/xilinx, /srv/git into the VM, then installs host-side"
            echo "Arrow USB Blaster .so. Java, sbt, udev rules, and blaster config are"
            echo "baked into the template."
            echo ""
            echo "Prerequisites:"
            echo "  mkdir -p /srv/git  (or use: $0 mirror add <url>)"
            exit 1
        fi
        SETUP_TYPE="$ARG3"
        case "$SETUP_TYPE" in
            jop-dev)
                echo "Setting up $VM_NAME as $SETUP_TYPE..."
                echo ""
                echo "Attaching host directories (config only, no restart)..."
                for dir in /opt/altera /opt/eclipse /opt/.p2 /opt/jdk1.6.0_45 /opt/jdk1.8.0_202 /opt/xilinx /srv/git; do
                    run_playbook share-dir -e "vm_name=$VM_NAME" -e "host_dir=$dir" -e "config_only=true"
                done
                echo ""
                echo "Restarting VM and mounting all shares..."
                "$0" mount-shares "$VM_NAME"
                echo ""
                echo "Installing host-side Blaster support..."
                "$0" install-blaster "$VM_NAME"
                echo ""
                echo "Setup complete for $VM_NAME ($SETUP_TYPE)."
                ;;
            *)
                echo "Unknown setup type: $SETUP_TYPE"
                echo "Supported types: jop-dev"
                exit 1
                ;;
        esac
        ;;
    help|--help|-h)
        echo "VM Management Tool"
        echo ""
        echo "Usage: $0 <command> [args]"
        echo ""
        echo "VM Commands:"
        echo "  create <name> <type> [mem] [cpu]  Create a VM (types: $(vm_role_types))"
        echo "  destroy <name>         Destroy a VM and clean up files"
        echo "  start <name>           Start a VM"
        echo "  stop <name>            Stop a VM (graceful shutdown)"
        echo "  status <name>          Show VM status"
        echo "  ip <name>              Print VM IP address"
        echo "  list                   List all VMs"
        echo "  ssh <name> [user]      SSH to VM (default user: peter)"
        echo "  copy-key <src> <dest>  Copy SSH key from src VM to dest VM"
        echo "  usb-list               List host USB devices (ID, iManufacturer, iProduct)"
        echo "  usb-serials            List USB serial ports and mapped USB identity"
        echo "  usb-attach <name> <usb_id> [usb_addr] [usb_name]  Attach USB device to VM (auto handoff)"
        echo "  usb-detach [name] <usb_id> [usb_addr] [usb_name]  Detach USB device (default: all VMs)"
        echo "  usb-detach-all [name]  Detach all USB devices from VM (or all VMs)"
        echo "  usb-cleanup <name>    Remove stale USB entries (unplugged devices)"
        echo "  usb-auto <name> <usb_id> [usb_name]  Auto-passthrough USB device to VM (udev)"
        echo "  usb-auto-remove <name> <usb_id>      Remove USB auto-passthrough"
        echo "  usb-auto-list                         List active auto-passthrough rules"
        echo "  install-blaster <name> [user]  Install Arrow USB Blaster support in VM"
        echo "  install-alchitry <name> [user] Install Alchitry AU udev rules in VM"
        echo "  install-spinalhdl <name> [user]  Install Java/Scala/sbt toolchain in VM"
        echo "  install-claude <name> [user]   Install Claude Code (default: creates claude user)"
        echo "  install-opencode <name> [user] Install OpenCode (default: creates opencode user)"
        echo "  install-vscode <name>         Install Visual Studio Code"
        echo "  install-codium <name>          Install VSCodium"
        echo "  resize-disk <name> <size>  Resize VM disk and grow guest filesystem"
        echo "  set-passwd <name> <user>   Set login password for user (for xrdp)"
        echo "  share-dir <name> <host_dir> [mount_point]  Share host dir into VM (read-only)"
        echo "  mount-shares <name>        Restart VM and mount all attached shares"
        echo "  setup <name> <type>        Run post-creation setup (types: jop-dev)"
        echo "  gui                        Launch graphical VM manager"
        echo ""
        echo "Mirror Commands:"
        echo "  mirror add <git-url>   Clone a repo to /srv/git"
        echo "  mirror list            List all repos"
        echo "  mirror sync [repo]     Pull updates for all or one repo"
        echo "  mirror remove <repo>   Remove a repo"
        echo ""
        echo "Template Commands:"
        echo "  template create <type> Create a template (common, git, mate, jop-dev)"
        echo "  template list          List all templates"
        echo "  template destroy <type> Remove a template"
        echo ""
        echo "Template Workflow (faster VM creation):"
        echo "  1. $0 template create common    # Hardened base"
        echo "  2. $0 template create git       # Git server template"
        echo "  2. $0 template create mate      # MATE desktop + xrdp template"
        echo "  2. $0 template create jop-dev   # MATE + FPGA dev tools template"
        echo "  3. $0 create jop01 jop-dev      # Fast instance from template"
        echo ""
        echo "Examples:"
        echo "  $0 create common01 common"
        echo "  $0 create jop01 jop-dev"
        echo "  $0 create git01 git"
        echo "  $0 ip claude01"
        echo "  $0 ssh claude01"
        echo "  $0 ssh claude01 claude"
        echo "  $0 ssh claude01 -- lsusb"
        echo "  $0 ssh claude01 claude -- lsusb"
        echo "  $0 copy-key claude01 git01    # Allow claude@claude01 to access git@git01"
        echo "  $0 usb-list"
        echo "  $0 usb-serials"
        echo "  $0 usb-attach claude01 09fb:6001 \"Altera Blaster\""
        echo "  $0 usb-attach jop 0403:6010 \"Arrow USB Blaster TEI0050\""
        echo "  $0 usb-attach fpga01 0403:6010 001:011 \"Arrow Blaster\""
        echo "  $0 usb-detach 09fb:6001 \"Altera Blaster\""
        echo "  $0 usb-detach fpga01 0403:6010 \"Arrow USB Blaster TEI0050\""
        echo "  $0 usb-detach-all pico"
        echo "  $0 usb-auto pico 2e8a:000a"
        echo "  $0 usb-auto jop-claude 09fb:6001 \"Altera Blaster\""
        echo "  $0 usb-auto-remove pico 2e8a:000a"
        echo "  $0 usb-auto-list"
        echo "  $0 install-blaster jop"
        echo "  $0 install-alchitry jop"
        echo "  $0 install-spinalhdl fpga01"
        echo "  $0 resize-disk jop 64G"
        echo "  $0 set-passwd jop claude"
        echo "  $0 share-dir jop /opt/xilinx/2025.2"
        echo "  $0 setup jop01 jop-dev"
        echo "  $0 mirror add https://github.com/jop-devel/jop.git"
        echo "  $0 mirror sync"
        echo "  $0 destroy claude01"
        ;;
    *)
        echo "Unknown command: $ACTION"
        echo "Run '$0 help' for usage"
        exit 1
        ;;
esac
