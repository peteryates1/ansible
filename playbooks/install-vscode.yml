---
# Install Visual Studio Code in a VM.
# Adds the Microsoft apt repo and installs the 'code' package.
#
# Usage:
#   ansible-playbook playbooks/install-vscode.yml -e vm_name=jop01
#
# Optional overrides:
#   -e vm_user=peter

- name: Prepare VM SSH target
  hosts: localhost
  become: true

  vars:
    requested_vm_name: "{{ vm_name | default('') }}"
    requested_vm_user: "{{ vm_user | default('peter') }}"
    requested_host_ssh_user: "{{ host_ssh_user | default(lookup('env', 'SUDO_USER') | default(lookup('env', 'USER'), true)) }}"

  tasks:
    - name: Validate vm_name
      fail:
        msg: "Usage: ansible-playbook playbooks/install-vscode.yml -e vm_name=<name> [-e vm_user=<user>]"
      when: requested_vm_name == ''

    - name: Check VM existence
      command: virsh list --all --name
      register: vm_list
      changed_when: false

    - name: Fail when VM does not exist
      fail:
        msg: "VM '{{ requested_vm_name }}' does not exist."
      when: requested_vm_name not in vm_list.stdout_lines

    - name: Check VM state
      command: virsh domstate {{ requested_vm_name | quote }}
      register: vm_state
      changed_when: false

    - name: Start VM if not running
      shell: |
        set -euo pipefail

        vm="{{ requested_vm_name }}"
        start_out="$(virsh start "$vm" 2>&1)" && {
          echo "started"
          exit 0
        }
        echo "$start_out" >&2

        if ! echo "$start_out" | grep -qi "Did not find USB device"; then
          exit 1
        fi

        xml_file="$(mktemp /tmp/${vm}-domain-XXXXXX.xml)"
        clean_xml_file="$(mktemp /tmp/${vm}-domain-clean-XXXXXX.xml)"
        cleanup() {
          rm -f "$xml_file" "$clean_xml_file"
        }
        trap cleanup EXIT

        virsh dumpxml "$vm" > "$xml_file"
        awk '
          BEGIN { skip=0 }
          /<hostdev[^>]*type=.usb./ { skip=1 }
          !skip { print }
          skip && /<\/hostdev>/ { skip=0 }
        ' "$xml_file" > "$clean_xml_file"

        if cmp -s "$xml_file" "$clean_xml_file"; then
          echo "Failed to start VM and no removable USB hostdev blocks were found." >&2
          exit 1
        fi

        virsh define "$clean_xml_file" >/dev/null
        retry_out="$(virsh start "$vm" 2>&1)" && {
          echo "started_after_usb_cleanup"
          exit 0
        }
        echo "$retry_out" >&2
        exit 1
      args:
        executable: /bin/bash
      when: "'running' not in (vm_state.stdout | lower)"
      register: vm_started
      changed_when: "'started' in vm_started.stdout"

    - name: Wait for VM boot after start
      pause:
        seconds: 10
      when: vm_started is changed

    - name: Resolve VM IP
      shell: |
        set -euo pipefail

        mac="$(virsh -c qemu:///system domiflist '{{ requested_vm_name }}' 2>/dev/null | awk 'NR > 2 && $5 ~ /^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$/ { print $5; exit }')"
        ip=""

        if [ -n "$mac" ]; then
          ip="$(virsh -c qemu:///system net-dhcp-leases default 2>/dev/null | awk -v mac="$mac" '
            BEGIN { IGNORECASE = 1 }
            $0 ~ mac {
              split($5, parts, "/")
              print parts[1]
              exit
            }
          ')"
          if [ -z "$ip" ]; then
            ip="$(virsh -c qemu:///system net-dumpxml default 2>/dev/null | awk -v mac="$mac" '
              BEGIN { IGNORECASE = 1 }
              $0 ~ mac && /ip=/ {
                gsub(/.*ip=["\047]/, "")
                gsub(/["\047].*/, "")
                print
                exit
              }
            ')"
          fi
        fi

        if [ -z "$ip" ]; then
          ip="$(virsh -c qemu:///system domifaddr '{{ requested_vm_name }}' 2>/dev/null | awk '
            /ipv4/ {
              split($4, parts, "/")
              print parts[1]
              exit
            }
          ')"
        fi

        echo "$ip"
      args:
        executable: /bin/bash
      register: vm_ip
      changed_when: false
      retries: 12
      delay: 5
      until: vm_ip.stdout != ""

    - name: Resolve SSH identity arguments from host SSH config
      shell: |
        set -euo pipefail

        ssh_config="/home/{{ requested_host_ssh_user }}/.ssh/config"
        if [ -f "$ssh_config" ]; then
          identity_lines="$(ssh -F "$ssh_config" -G "{{ vm_ip.stdout }}" 2>/dev/null | awk '/^identityfile / { print $2 }')"
        else
          identity_lines="$(ssh -G "{{ vm_ip.stdout }}" 2>/dev/null | awk '/^identityfile / { print $2 }')"
        fi

        printf '%s\n' "$identity_lines" \
          | sed "s#^~/#/home/{{ requested_host_ssh_user }}/#" \
          | awk 'NF && !seen[$0]++ { print }' \
          | while IFS= read -r key; do
              [ -f "$key" ] || continue
              case "$key" in
                *.pub) continue ;;
              esac
              printf -- "-o IdentityFile=%s " "$key"
            done
      args:
        executable: /bin/bash
      register: resolved_identity_args
      changed_when: false

    - name: Add dynamic SSH target host
      add_host:
        name: vscode_target
        groups: vscode_targets
        ansible_host: "{{ vm_ip.stdout }}"
        ansible_user: "{{ requested_vm_user }}"
        ansible_ssh_common_args: >-
          {{
            ((resolved_identity_args.stdout | trim) ~ ' ')
            if (resolved_identity_args.stdout | trim) != ''
            else ''
          }}-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null

- name: Install Visual Studio Code in VM
  hosts: vscode_targets
  become: true
  gather_facts: false

  tasks:
    - name: Wait for SSH
      wait_for_connection:
        timeout: 300

    - name: Clean up conflicting VS Code apt sources
      shell: |
        set -euo pipefail
        rm -f /usr/share/keyrings/microsoft-archive-keyring.gpg
        rm -f /etc/apt/sources.list.d/vscode*.list /etc/apt/sources.list.d/vscode*.sources
      args:
        executable: /bin/bash
      changed_when: false

    - name: Add Microsoft GPG key
      shell: |
        set -euo pipefail
        if [ ! -f /usr/share/keyrings/microsoft.gpg ]; then
          curl -fsSL https://packages.microsoft.com/keys/microsoft.asc \
            | gpg --dearmor -o /usr/share/keyrings/microsoft.gpg
          echo "installed"
        else
          echo "exists"
        fi
      args:
        executable: /bin/bash
      register: gpg_result
      changed_when: "'installed' in gpg_result.stdout"

    - name: Add VS Code apt repository
      copy:
        dest: /etc/apt/sources.list.d/vscode.list
        content: "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main\n"
        mode: '0644'

    - name: Install VS Code
      apt:
        name: code
        state: present
        update_cache: true

    - name: Create custom desktop launcher with --no-sandbox
      copy:
        dest: /usr/share/applications/code.desktop
        content: |
          [Desktop Entry]
          Type=Application
          Name=VS Code
          Exec=/usr/bin/code --no-sandbox --unity-launch %F
          Icon=vscode
          Categories=Development;IDE;
        mode: '0644'

    - name: Add VS Code to MATE panel layout
      shell: |
        set -euo pipefail

        layout="/usr/share/mate-panel/layouts/jop-dev.layout"
        [ -f "$layout" ] || exit 0

        # Skip if already present
        grep -q 'launcher-vscode' "$layout" && exit 0

        # Find highest position on top-panel
        max_pos="$(awk -F= '/toplevel-id=top-panel/{tp=1} tp && /^position=/{print $2; tp=0}' "$layout" \
          | sort -n | tail -1)"
        new_pos=$((max_pos + 1))

        # Insert before notification-area (right-stick section)
        awk -v new_pos="$new_pos" '
        /^\[Object notification-area\]/ {
          printf "[Object launcher-vscode]\n"
          printf "object-type=launcher\n"
          printf "toplevel-id=top-panel\n"
          printf "launcher-location=/usr/share/applications/code.desktop\n"
          printf "position=%d\n\n", new_pos
        }
        { print }
        ' "$layout" > "${layout}.tmp"
        mv "${layout}.tmp" "$layout"
      args:
        executable: /bin/bash
      changed_when: true

    - name: Add VS Code launcher to existing MATE user sessions
      shell: |
        set -euo pipefail

        for home_dir in /home/*; do
          [ -d "$home_dir" ] || continue
          user="$(basename "$home_dir")"
          id "$user" >/dev/null 2>&1 || continue

          # Check if user has a MATE panel config
          db_dir="$home_dir/.config/dconf"
          [ -d "$db_dir" ] || continue

          # Read current object list
          obj_list="$(sudo -u "$user" dbus-launch dconf read /org/mate/panel/general/object-id-list 2>/dev/null || true)"
          [ -n "$obj_list" ] || continue

          # Skip if already has vscode launcher
          echo "$obj_list" | grep -q "launcher-vscode" && continue

          # Add launcher object ID to list
          new_list="$(echo "$obj_list" | sed "s/]$/, 'launcher-vscode']/")"
          sudo -u "$user" dbus-launch dconf write /org/mate/panel/general/object-id-list "$new_list"

          # Configure the launcher object
          sudo -u "$user" dbus-launch dconf write /org/mate/panel/objects/launcher-vscode/object-type "'launcher'"
          sudo -u "$user" dbus-launch dconf write /org/mate/panel/objects/launcher-vscode/toplevel-id "'top-panel'"
          sudo -u "$user" dbus-launch dconf write /org/mate/panel/objects/launcher-vscode/launcher-location "'/usr/share/applications/code.desktop'"
          sudo -u "$user" dbus-launch dconf write /org/mate/panel/objects/launcher-vscode/position 10
        done
      args:
        executable: /bin/bash
      changed_when: true

    - name: Display summary
      debug:
        msg: |
          Visual Studio Code installed successfully.
          Panel launcher added. Log out and back in for it to appear.
