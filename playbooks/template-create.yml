---
# Create a VM template
# Usage:
#   ansible-playbook playbooks/template-create.yml -e template_type=common
#   ansible-playbook playbooks/template-create.yml -e template_type=claude
#   ansible-playbook playbooks/template-create.yml -e template_type=git
#   ansible-playbook playbooks/template-create.yml -e template_type=opencode
#   ansible-playbook playbooks/template-create.yml -e template_type=mate

- name: Create VM template
  hosts: localhost
  become: true

  vars:
    template_type: "{{ template_type | default('') }}"
    base_image_dir: /var/lib/libvirt/images
    template_dir: "{{ base_image_dir }}/templates"
    builder_name: "template-{{ template_type }}-builder"
    builder_dir: "{{ base_image_dir }}/{{ builder_name }}"
    requested_host_ssh_user: "{{ host_ssh_user | default(lookup('env', 'SUDO_USER') | default(lookup('env', 'USER'), true)) }}"
    requested_ssh_authorized_keys_file: "{{ ssh_authorized_keys_file | default('/home/' ~ requested_host_ssh_user ~ '/.ssh/authorized_keys') }}"

  tasks:
    - name: Validate template type
      fail:
        msg: "Invalid template_type '{{ template_type }}'. Must be: common, claude, git, opencode, or mate"
      when: template_type not in ['common', 'claude', 'git', 'opencode', 'mate']

    - name: Set template file paths
      set_fact:
        common_template: "{{ template_dir }}/common-hardened.qcow2"
        template_output: "{{ template_dir }}/{{ template_type }}-base.qcow2"

    - name: Adjust output name for common template
      set_fact:
        template_output: "{{ template_dir }}/common-hardened.qcow2"
      when: template_type == 'common'

    - name: Set common template base image path
      set_fact:
        common_base_image: "{{ base_image_dir }}/debian-13-generic-amd64.qcow2"
      when: template_type == 'common'

    - name: Check if template already exists
      stat:
        path: "{{ template_output }}"
      register: template_exists

    - name: Fail if template already exists
      fail:
        msg: "Template {{ template_output }} already exists. Destroy it first: ./vm template destroy {{ template_type }}"
      when: template_exists.stat.exists

    - name: Check parent template exists (for claude/git)
      stat:
        path: "{{ common_template }}"
      register: common_exists
      when: template_type in ['claude', 'git', 'opencode', 'mate']

    - name: Fail if common template missing
      fail:
        msg: "common-hardened template required. Create it first: ./vm template create common"
      when: template_type in ['claude', 'git', 'opencode', 'mate'] and not common_exists.stat.exists

    - name: Create template directory
      file:
        path: "{{ template_dir }}"
        state: directory
        mode: '0755'

    - name: Create builder directory
      file:
        path: "{{ builder_dir }}"
        state: directory
        mode: '0755'

    - name: Set backing image for common template
      set_fact:
        backing_image: "{{ common_base_image }}"
      when: template_type == 'common'

    - name: Set backing image for role templates
      set_fact:
        backing_image: "{{ common_template }}"
      when: template_type in ['claude', 'git', 'opencode', 'mate']

    - name: Download base image if needed
      get_url:
        url: https://cloud.debian.org/images/cloud/trixie/latest/debian-13-generic-amd64.qcow2
        dest: "{{ common_base_image }}"
        mode: '0644'
      when: template_type == 'common'

    - name: Create builder disk with backing file
      command: >
        qemu-img create -f qcow2 -F qcow2
        -b {{ backing_image }}
        {{ builder_dir }}/{{ builder_name }}.qcow2 32G
      args:
        creates: "{{ builder_dir }}/{{ builder_name }}.qcow2"

    - name: Check SSH authorized keys file
      stat:
        path: "{{ requested_ssh_authorized_keys_file }}"
      register: ssh_authorized_keys_file_stat

    - name: Fail when SSH authorized keys file is missing
      fail:
        msg: "SSH authorized keys file not found: {{ requested_ssh_authorized_keys_file }}"
      when: not ssh_authorized_keys_file_stat.stat.exists

    - name: Load SSH authorized keys
      set_fact:
        ssh_authorized_keys: "{{ lookup('file', requested_ssh_authorized_keys_file).split('\n') | select | list }}"

    - name: Include template-specific vars
      include_vars:
        file: "../roles/{{ template_type }}/vars/main.yml"
      when: template_type in ['claude', 'git', 'opencode', 'mate']

    - name: Set common template vars
      set_fact:
        extra_users: []
        extra_packages: []
        extra_runcmd: []
      when: template_type == 'common'

    - name: Generate cloud-init user-data
      template:
        src: "../roles/common/templates/user-data.yml.j2"
        dest: "{{ builder_dir }}/user-data"
        mode: '0644'
      vars:
        vm_name: "{{ builder_name }}"

    - name: Generate cloud-init meta-data
      template:
        src: "../roles/common/templates/meta-data.yml.j2"
        dest: "{{ builder_dir }}/meta-data"
        mode: '0644'
      vars:
        vm_name: "{{ builder_name }}"

    - name: Generate cloud-init network-config
      template:
        src: "../roles/common/templates/network-config.yml.j2"
        dest: "{{ builder_dir }}/network-config"
        mode: '0644'
      vars:
        vm_name: "{{ builder_name }}"

    - name: Generate cloud-init ISO
      command: >
        genisoimage -output {{ builder_dir }}/cloud-init.iso
        -volid cidata -joliet -rock
        {{ builder_dir }}/user-data {{ builder_dir }}/meta-data {{ builder_dir }}/network-config
      args:
        creates: "{{ builder_dir }}/cloud-init.iso"

    - name: Check if builder VM already exists
      command: virsh list --all --name
      register: existing_vms
      changed_when: false

    - name: Clean up existing builder VM if present
      block:
        - name: Destroy running builder VM
          command: virsh destroy {{ builder_name | quote }}
          ignore_errors: true

        - name: Undefine existing builder VM
          command: virsh undefine {{ builder_name | quote }}
          ignore_errors: true
      when: builder_name in existing_vms.stdout_lines

    - name: Create builder VM
      command: >
        virt-install
        --name {{ builder_name }}
        --memory 8192
        --vcpus 4
        --disk {{ builder_dir }}/{{ builder_name }}.qcow2,device=disk,bus=virtio
        --disk {{ builder_dir }}/cloud-init.iso,device=cdrom
        --os-variant debian11
        --virt-type kvm
        --network network=default
        --serial file,path={{ builder_dir }}/console.log
        --console pty,target_type=serial
        --import
        --noautoconsole

    - name: Wait for cloud-init to complete (checking console log)
      shell: |
        for i in $(seq 1 120); do
          if grep -q "Cloud-init.*finished" "{{ builder_dir }}/console.log" 2>/dev/null; then
            echo "Cloud-init completed"
            exit 0
          fi
          if grep -q "final_message" "{{ builder_dir }}/console.log" 2>/dev/null; then
            echo "Cloud-init completed (final message found)"
            exit 0
          fi
          if grep -q "boot stage final" "{{ builder_dir }}/console.log" 2>/dev/null; then
            echo "Cloud-init completed (boot stage final)"
            exit 0
          fi
          if grep -q "VM setup complete" "{{ builder_dir }}/console.log" 2>/dev/null; then
            echo "Cloud-init completed (VM setup complete)"
            exit 0
          fi
          sleep 10
        done
        echo "Timeout waiting for cloud-init"
        exit 1
      register: cloud_init_wait
      changed_when: false

    - name: Display cloud-init status
      debug:
        msg: "{{ cloud_init_wait.stdout }}"

    - name: Shutdown builder VM gracefully
      command: virsh shutdown {{ builder_name | quote }}
      register: shutdown_result
      ignore_errors: true

    - name: Wait for VM to shut down
      shell: |
        for i in $(seq 1 30); do
          if ! virsh list --state-running | grep -q {{ builder_name | quote }}; then
            echo "VM shut down"
            exit 0
          fi
          sleep 2
        done
        echo "Forcing shutdown"
        virsh destroy {{ builder_name | quote }} || true
      changed_when: false

    - name: Ensure template image uses generic kernel and has usbutils
      command:
        argv:
          - virt-customize
          - -a
          - "{{ builder_dir }}/{{ builder_name }}.qcow2"
          - --install
          - linux-image-amd64,usbutils
          - --run-command
          - apt-get purge -y linux-image-cloud-amd64 || true
          - --run-command
          - apt-get purge -y 'linux-image-*-cloud-amd64' || true
          - --run-command
          - update-grub || true
      register: kernel_customize_result
      when: template_type == 'common'

    - name: Display kernel customization output
      debug:
        msg: "{{ kernel_customize_result.stdout_lines | default([]) }}"
      when: template_type == 'common' and kernel_customize_result.stdout_lines is defined

    - name: Run virt-sysprep to clean template
      command: >
        virt-sysprep
        --operations defaults,-ssh-userdir
        -a {{ builder_dir }}/{{ builder_name }}.qcow2
      register: sysprep_result

    - name: Display virt-sysprep output
      debug:
        msg: "{{ sysprep_result.stdout_lines | default([]) }}"
      when: sysprep_result.stdout_lines is defined

    - name: Flatten disk to template (removes backing file dependency)
      command: >
        qemu-img convert -O qcow2
        {{ builder_dir }}/{{ builder_name }}.qcow2
        {{ template_output }}

    - name: Undefine builder VM
      command: virsh undefine {{ builder_name | quote }}
      ignore_errors: true

    - name: Clean up builder directory
      file:
        path: "{{ builder_dir }}"
        state: absent

    - name: Get template size
      stat:
        path: "{{ template_output }}"
      register: template_stat

    - name: Template created
      debug:
        msg: |
          Template created successfully!
          Path: {{ template_output }}
          Size: {{ (template_stat.stat.size / 1024 / 1024) | round(1) }} MB
